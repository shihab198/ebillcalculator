<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bill History</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f9; padding: 20px; }
    h1 { text-align: center; color: #333; }
    .history-card {
      background: white; padding: 20px; margin: 15px 0;
      border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .history-header { display: flex; justify-content: space-between; margin-bottom: 10px;
      font-weight: bold; color: #667eea; }
    .history-body { font-family: monospace; font-size: 14px; color: #333; white-space: pre-wrap; }
    .btn {
      display: inline-block; padding: 8px 14px; margin: 8px 5px 0 0;
      background: #667eea; color: white; border: none; border-radius: 6px;
      text-decoration: none; cursor: pointer; font-size: 14px;
    }
    .delete-btn { background: #e53e3e; }
    .pdf-btn { background: #38a169; }
    .export-all { background: #3182ce; margin: 15px 0; display: block; }
  </style>
</head>
<body>
  <h1>ðŸ“œ Electricity Bill History</h1>
  <a href="index.html" class="btn">â¬… Back to Calculator</a>
  <button class="btn export-all" onclick="exportAllPDF()">ðŸ“„ Export All Bills (PDF)</button>

  <div id="history"></div>

  <script>
    let db;
    const request = indexedDB.open("BillCalculatorDB", 1);
    request.onsuccess = function(event) {
      db = event.target.result;
      loadHistory();
    };

    function loadHistory() {
      const tx = db.transaction("bills", "readonly");
      const store = tx.objectStore("bills");
      const request = store.getAll();

      request.onsuccess = function() {
        const history = request.result;
        const container = document.getElementById("history");
        container.innerHTML = "";

        if (history.length === 0) {
          container.innerHTML = "<p>No history found.</p>";
          return;
        }

        history.forEach(entry => {
          const card = document.createElement("div");
          card.classList.add("history-card");

          card.innerHTML = `
            <div class="history-header">
              <span>${entry.date}</span>
              <span>Total: à§³${entry.totalBill.toFixed(2)}</span>
            </div>
            <div class="history-body">
Shops:
${entry.shops.map(shop => 
`${shop.name}: ${shop.consumption.toFixed(2)} kWh 
Bill: à§³${shop.bill.toFixed(2)}`
).join("\n\n")}
            </div>
            <button class="btn pdf-btn" onclick="exportPDF(${entry.id})">ðŸ“„ Export PDF</button>
            <button class="btn delete-btn" onclick="deleteBill(${entry.id})">ðŸ—‘ Delete</button>
          `;
          container.appendChild(card);
        });
      };
    }

    function deleteBill(id) {
      const tx = db.transaction("bills", "readwrite");
      const store = tx.objectStore("bills");
      store.delete(id);
      loadHistory();
    }

    // Export single bill
    function exportPDF(id) {
      const tx = db.transaction("bills", "readonly");
      const store = tx.objectStore("bills");
      const request = store.get(id);

      request.onsuccess = function() {
        const entry = request.result;
        if (!entry) return;

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        generateBillPDF(doc, entry);
        doc.save(`Bill_${entry.date.replace(/[: ,]/g, "_")}.pdf`);
      };
    }

    // Export ALL bills in one file
    function exportAllPDF() {
      const tx = db.transaction("bills", "readonly");
      const store = tx.objectStore("bills");
      const request = store.getAll();

      request.onsuccess = function() {
        const bills = request.result;
        if (bills.length === 0) {
          alert("No history to export.");
          return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        bills.forEach((entry, index) => {
          if (index > 0) doc.addPage(); // new page for each bill
          generateBillPDF(doc, entry);
        });

        doc.save("All_Bills.pdf");
      };
    }

    // PDF generator function
    function generateBillPDF(doc, entry) {
      doc.setFont("helvetica", "bold");
      doc.setFontSize(16);
      doc.text("Electricity Bill", 20, 20);

      doc.setFontSize(12);
      doc.setFont("helvetica", "normal");
      doc.text(`Date: ${entry.date}`, 20, 35);
      doc.text(`Total Bill: à§³${entry.totalBill.toFixed(2)}`, 20, 45);

      let y = 60;
      entry.shops.forEach(shop => {
        doc.text(`${shop.name}`, 20, y);
        doc.text(`Usage: ${shop.consumption.toFixed(2)} kWh`, 40, y + 8);
        doc.text(`Bill: à§³${shop.bill.toFixed(2)}`, 40, y + 16);
        y += 30;
      });
    }
  </script>
</body>
</html>
